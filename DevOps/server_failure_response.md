# 장애대응 매뉴얼

- 의문
- 개요
- 장애 대응 매뉴얼
  - 1 장애 파악(ADAIN)
    - Alert
    - Database
    - Application
    - Infra
    - Network
  - 2 장애 조치
  - 3 장애 예방
  - 4 공유

## 의문

## 개요

- 데브옵스 사상(CAMSP)
  - Culture
  - Automation
  - Measurement
  - Share
  - Pile up

## 장애 대응 매뉴얼

- 장애 파악
- 장애 조치
- 장애 예방
- 공유
  - 공유까지 진행해야 올바른 장애 대응이라고 할 수 있다

### 1. 장애 파악(ADAIN)

- 개요
  - 장애가 어디서 어떻게 났는지 쉽게 파악하기 위한 프레임워크
    - 앞에서 뒤로 문제를 더 빨리 찾을 수 있는 가능성이 높은 순서대로 나열되어있다
      - Alert을 먼저 보는게 Network부분을 먼저보는것 보다 문제를 빠르게 특정할 수 있는 가능성이 높아짐
    - **각 페이즈마다 USE(Utilization, Saturation, Error) method, TSA(Thread State Analysis) method등의 방법론을 적절히 사용하면 좋다**
- ADAIN
  - Alert
  - Database
  - Application
  - Infrastucture
  - Network

#### 1.1 얼럿 확인(Alert)

- 개요
  - 장애가 자주 나는 부분 및 한 번 장애가 났던 부분은 메트릭설정으로 쉽게 얼럿을 받을 수 있도록 해야한다
- 조사대상(E)
  - 센트리 얼럿
    - 어떤 에러가 나고 있는지?
    - 장애의 원인이 되는것으로 보이는 에러의 모든 이벤트 파악하기
  - 프로메테우스 메트릭 얼럿

#### 1.2 DB 이슈인가?(DB)

- 개요
  - 일반적으로 웹 서버의 경우 DB가 병목이 되는 경우가 많다
- 조사대상(USE)
  - AWS AuroraDB cloud watch
    - CPU / Memory / DB connection 수(max 확인)
      - US 체크
  - AWS AuroraDB performance insights
    - **실시간 5분으로 세팅해두고 지속 모니터링(어떤 쿼리가 어떤 이유에서 블로킹 되어있는지 확인)**
      - US 체크
  - 실제 DB 들어가서
    - `select * from information_schema.processlist (where info is not null)`
      - 스레드들의 상태를 관찰(데드락 등)
      - E 체크
- 대응 사례
  - 데드락
  - 커넥션 이슈
  - long running tx로 인한 rollback history가 너무 많이 자라는 문제
  - 메모리 문제
  - CPU를 너무 많이 사용하는 문제

#### 1.3 서버 이슈인가?(Application server)

- 조사대상(USE)
  - k8s
    - grafana(US)
      - deployments
      - pods
      - jvm micrometer
        - TSA방법론 적용
    - 팟 로그 확인(E)
  - 얼럿 확인
    - E

#### 1.4 인프라 이슈인가?(Infra)

- 개요
  - DB를 제외한 서비스를 구성하는 전체 인프라 리소스들
  - e.g)
    - AWS SQS
    - AWS Kinesis
    - k8s 등
- 모니터링
  - k8s
    - k8s cluster use method
    - istio service
    - k8s events
  - AWS
    - AWS cloud watch(USE)

#### 1.5 네트워크 이슈인가?(Network)

- 모니터링
  - 네트워크 관련 메트릭 관찰(US)
    - e.g) istio service, AWS ALB, Ingress등
  - 얼럿(E)
- 대응사례

### 2. 장애 조치

- 개요
  - 장애 포인트를 특정하고 나서, 원상태로 회복시키는 단계
- 방법론
  - 장애 파악시에 스냅샷을 잘 남기자
    - 추후에 원인 특정 및 개선시 유리
    - e.g) mysql process kill 이전에 미리 어떤 쿼리였고, 어떤 유저였는지 체크하기

### 3. 장애 예방

- 개요
  - 원상태로 회복이 된 이후에, 장애가 재발되지 않도록 예방하는 단계
- 방법론
  - 얼럿 추가
  - 테스트 추가
  - 예외 추가

### 4. 공유

- 개요
  - 개발팀 뿐 아니라, 비개발팀도 이해할 수 있는 장애에 관련된 전반적인 내용을 공유하여 투명한 커뮤니케이션을 지향한다
- 방법론
  - 서버 팀 내부 공유
  - 다른 팀 외부 공유
    - 기술적인 용어는 알기 쉽게 풀어서 써주자
- 문서 프레임워크
  - 현상
  - 대응
  - 원인
  - 조취

#### 장애 문서 작성 예시

예시

```
현상
10월 19일 12시 5분경부터 10월 19일 12시 55분까지 드라이버 서버의 출근하기, 하차완료하기 등의 동작이 되지 않은 문제가 발생했습니다.

원인
드라이버 서버를 배포하는 과정에서 데이터베이스 내부에서 실행되는 몇 개의 명령어가 종료되지 않고 계속 실행되는 기술적 버그(deadlock)으로 인해, 출근하기, 하차완료하기 등의 요청이 처리되지 않고 쌓이면서 문제가 발생했습니다.

대응
현상을 파악한 후, 데이터베이스에서 긴 시간동안 대기하고 있는 명령어들을 제거하면서 병목을 해결하였고, 해당 문제도 해결되었습니다.

대책
해당 이슈는 서버팀에서 인지하고 해결하려고 하는 문제이고(일반적인 경우에는 지금과 같은 큰 장애로 이어지지 않습니다), 조만간 문제를 예방하기 위해 APM 등을 도입하여 병목 지점을 특정짓고 코드를 수정하겠습니다.
또한 장애 발생 시 모니터링 알림이 오지 않는 문제가 있는데, 관련해서도 알람 조건을 개선해서 문제 발생 시 빠르게 조치할 수 있도록 모니터링 시스템을 강화하겠습니다.
```
