# 장애대응 매뉴얼

- 의문
- 개요
- 장애 대응 매뉴얼
  - 1 장애 파악(AINDA)
  - 2 장애 조치
  - 3 장애 예방
  - 4 공유

## 의문

## 개요

- 데브옵스 사상(CAMSP)
  - Culture
  - Automation
  - Measurement
  - Share
  - Pile up

## 장애 대응 매뉴얼

- 장애 파악
- 장애 조치
- 장애 예방
- 공유
  - 공유까지 진행해야 올바른 장애 대응이라고 할 수 있다

### 1. 장애 파악(AINDA)

- 개요
  - 장애가 어디서 어떻게 났는지 파악하는 세션
- 체크 포인트
  - 얼럿 확인(Alert)
    - 센트리 얼럿
      - 어떤 에러가 나고 있는지?
      - 장애의 원인이 되는것으로 보이는 에러의 모든 이벤트 파악하기
  - 인프라 이슈인가?(Infra)
    - 모니터링
      - k8s
        - k8s cluster use method
        - istio service
        - k8s events
      - AWS
        - AWS cloud watch
  - 네트워크 이슈인가?(Network)
    - 모니터링
      - 네트워크 메트릭 관찰
        - e.g) istio service, AWS ALB
      - 얼럿
    - 대응사례
  - DB 이슈인가?(DB)
    - 모니터링
      - AWS AuroraDB cloud watch
        - CPU / Memory / DB connection 수(max 확인)
      - AWS AuroraDB performance insights
        - **실시간 5분으로 세팅해두고 지속 모니터링(어떤 쿼리가 어떤 이유에서 블로킹 되어있는지 확인)**
      - 실제 DB 들어가서
        - `select * from information_schema.processlist (where info is not null)`
          - 스레드들의 상태를 관찰(데드락 등)
    - 대응 사례
      - 데드락
      - 커넥션 이슈
      - long running tx로 인한 rollback history가 너무 많이 자라는 문제
  - 서버 이슈인가?(Application server)
    - 모니터링
      - k8s
        - deployments
        - pods
        - jvm micrometer
      - 얼럿 확인
      - 서버 로그 확인

### 2. 장애 조치

- 개요
  - 장애 포인트를 특정하고 나서, 원상태로 회복시키는 단계
- 방법론
  - 장애 파악시에 로깅을 잘 남기자
    - 추후에 원인 특정에 유리
    - e.g) mysql process kill 이전에 미리 어떤 쿼리였고, 어떤 유저였는지 체크하기

### 3. 장애 예방

- 개요
  - 원상태로 회복이 된 이후에, 장애가 재발되지 않도록 예방하는 단계
- 방법론
  - 얼럿 추가
  - 테스트 추가
  - 예외 추가

### 4. 공유

- 개요
  - 개발팀 뿐 아니라, 비개발팀도 이해할 수 있는 장애에 관련된 전반적인 내용을 공유하여 투명한 커뮤니케이션을 지향한다
- 방법론
  - 서버 팀 내부 공유
  - 다른 팀 외부 공유
    - 기술적인 용어는 알기 쉽게 풀어서 써주자
- 문서 프레임워크
  - 현상
  - 대응
  - 원인
  - 조취

#### 장애 문서 작성 예시

예시

```
현상
10월 19일 12시 5분경부터 10월 19일 12시 55분까지 드라이버 서버의 출근하기, 하차완료하기 등의 동작이 되지 않은 문제가 발생했습니다.

원인
드라이버 서버를 배포하는 과정에서 데이터베이스 내부에서 실행되는 몇 개의 명령어가 종료되지 않고 계속 실행되는 기술적 버그(deadlock)으로 인해, 출근하기, 하차완료하기 등의 요청이 처리되지 않고 쌓이면서 문제가 발생했습니다.

대응
현상을 파악한 후, 데이터베이스에서 긴 시간동안 대기하고 있는 명령어들을 제거하면서 병목을 해결하였고, 해당 문제도 해결되었습니다.

대책
해당 이슈는 서버팀에서 인지하고 해결하려고 하는 문제이고(일반적인 경우에는 지금과 같은 큰 장애로 이어지지 않습니다), 조만간 문제를 예방하기 위해 APM 등을 도입하여 병목 지점을 특정짓고 코드를 수정하겠습니다.
또한 장애 발생 시 모니터링 알림이 오지 않는 문제가 있는데, 관련해서도 알람 조건을 개선해서 문제 발생 시 빠르게 조치할 수 있도록 모니터링 시스템을 강화하겠습니다.
```
