# k8s 클러스터 아키텍처

- 의문
- 개요
- 노드
  - 노드 상태
  - 하트비트
  - 노드 컨트롤러
  - 리소스 용량 추적

## 의문

## 개요

## 노드

- 개요
  - 팟내에 배치된 컨테이너를 실행하는 물리 / 가상 머신
- 특징
  - 컨트롤 플레인에 의해서 관리됨
  - 팟을 실행하는 데 필요한 컴포넌트 포함
    - **컨테이너 런타임, kubelet, kube-proxy**
  - 노드의 이름은 고유해야 함
- API서버에 노드 추가
  - 방법
    - 노드의 kubelet으로 컨트롤 플레인에 자체 등록
    - 사용자가 노드 오브젝트를 수동으로 추가
  - 순서
    - 위의 방법실행
    - k8s는 내부적으로 노드 오브젝트 생성
    - k8s는 노드의 `metadata.name`필드와 일치하는 API 서버에 등록이 되어있는지 확인
    - 노드의 상태
      - 정상이면 팟 실행 가능
      - 비정상이면 해당 노드는 정상이 될때까지 모든 클러스터 활동에 대해서 무시됨

### 노드 상태

`kubectl describe node <노드 이름>`으로 노드의 상태를 파악 가능

- 주소(Addresses)
  - HostName
    - 노드의 커널에 의해 알려진 호스트명
    - `--hostname-override` 파라미터를 통해 치환될 수 있음
  - ExternalIP
    - 노드의 IP주소는 외부로 라우트 가능(클러스터 외부에서 이용 가능)
  - InternalIP
    - 노드의 IP주소는 클러스터 내에서만 라우트 가능
- 컨디션(Conditions)
  - 개요
    - Running노드의 상태를 기술
  - 종류
    - `Ready`
      - `True`
        - 노드가 양호하며 팟을 수용할 준비가 되어있는 경우
      - `False`
        - 노드의 상태가 불량하여 팟을 수용하지 못할 경우
      - `Unknown`
        - 노드 컨트롤러가 마지막 `node-monitor-grace-period` (기본값 40)기간 동안 노드로부터 응답을 받지 못한 경우
          - *어떤 응답? 누가 대답하는거? kubelet*
    - `MemoryPressure`
      - 노드 메모리가 넉넉치 않은 경우
    - `DiskPressure`
      - 노드 디스크가 넉넉치 않은 경우
    - `PIDPressure`
      - 노드 상에 많은 프로세스들이 존재하는 경우(프로세스 상의 압박)
    - `NetworkUnavailable`
      - 노드에 대해 네트워크가 올바르게 구성되지 않은 경우
  - 특징
    - ready 컨디션의 status가 `pod-eviction-timeout`(default 5분)보다 더 길게 `Unknown`또는 `False`로 유지되는 경우, 노드 컨트롤러가 해동 노드에 할당된 전체 팟에 대해 API를 이용한 eviction을 트리거 함
      - taint가 아님
    - 노드에 접근이 불가할 떄와 같은 경우, API서버는 노드 상의 kubelet과 통신이 불가하여, API 서버와의 통신이 재개될 떄까지 팟 삭제에 대한 결정은 kubelet에 전해질 수 없음
      - 그 사이, 삭제되도록 스케줄된 팟은 분할된 노드 상에서 계속 동작할 수도 있음
    - 노드에 문제가 발생하면, 쿠버네티스 컨트롤 플레인은 자동으로 노드 상태에 영향을 주는 조건과 일치하는 테인트를 생성
    - 스케쥴러 팟을 노드에 할당할 때 노드의 테인트를 고려
- 용량과 할당가능(Capacity / Allocable)
  - 개요
    - 노드 상에 사용 가능한 리소스
      - CPU, 메모리, 노드상에 스케쥴 될 수 있는 최대 팟 수
    - 용량은 리소스 총량, 할당가능은 일반 팟에서 사용할 수 있는 노드의 리소스양
- 정보(System Info)
  - 커널 버전
  - 쿠버네티스 버전(kubelet, kube-proxy버전)
  - 컨테이너 런타임 상세 정보
  - 노드가 사용하는 운영체제
  - 특징
    - kubelet이 노드에서 수집하여 쿠버네티스 API로 전송

### 하트비트

- 개요
  - 크러스터가 개별 노드가 가용한지를 판단할 수 있도록 도움을 줌
- 종류
  - `.status`에 대한 업데이트
  - `kube-node-lease`네임스페이스 내의 리스 오브젝트. 각 노드는 연관된 리스 오브젝트를 갖음
    - `.status`에 비하면 경랑 리소스이며, 큰 클러스터에서는 리스를 하트비트에 사용하여 업데이트로인한 성능 영향 줄일 수 있음
- 특징
  - `kubelet`은 상태가 변경되거나 설정된 인터벌보다 오래 업데이트가 없는 경우, 노드의 `.status`를 업데이트 함. 노드의 `.status`업데이트에 대한 기본 인터벌은 접근이 불가능한 노드에 대한 타임아웃인 40초 보다 훨씬 긴 5분
  - kubelet은 리스 오브젝트를 (기본 업데이트 인터벌인) 매 10초마다 생성하고 업데이트한다. 리스 업데이트는 노드의 .status 업데이트와는 독립적이다. 만약 리스 업데이트가 실패하면, kubelet은 200밀리초에서 시작하고 7초의 상한을 갖는 지수적 백오프를 사용해서 재시도한다.

### 노드 컨트롤러

- 개요
  - 노드를 관리하는 쿠버네티스 컨트롤 플레인 컴포넌트
- 역할
  - 1 등록 시점에 노드에 CIDR블럭을 할당
  - 2 노드 컨트롤러의 내부 노드 리스트를 클라우드 제공사업자의 사용 가능한 머신 리스트 정보를 근거로 최신 상태로 유지
  - 3 노드 상태를 모니터링(5초마다)
    - 접근 불가능 상태가 되는 경우, `.status`필드의 `Ready`컨디션을 업데이트, 이 경우 `Unknown`으로
    - 노드가 접근 불가능 상태로 남아있는 경우, 노드의 모든 팟에 대해서 API를 이용한 축출을 트리거
      - `Unknown`으로 마킹한 뒤 5분을 기다렸다가 최초의 축출 요청을 시작

### 리소스 용량 추적

- 개요
  - 노드 오브젝트는 노드 리소스 용량에 대한 정보를 추적
    - 사용 가능한 CPU, 메모리 양
    - *오브젝트가 추적하는건가? 컨트롤러가 아니라? 그럼 여기서 말하는 오브젝트는 뭐지? 노드 자신?*
  - 쿠버네티스 스케줄러는 노드 상에 모든 노드에 대해 충분한 리소스가 존재하도록 보장
    - 스케줄러는 노드 상에 컨테이너에 대한 요청의 합이 노드 용량보다 더 크지 않도록 체크
    - 컨테이너 런타임에 의해 직접적으로 시작된 컨테이너와 kubelet 컨트롤 범위 밖에서 실행되는 모든 프로세스도 제외
