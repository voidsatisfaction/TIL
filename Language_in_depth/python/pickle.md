# Pickle

- 의문
- 개요
  - 다른 모듈과의 비교
  - 데이터 스트림 형식
- 어떤 것이 피클 되고 역 피클 될 수 있는가?

## 의문

## 개요

- 개요
  - **파이썬 객체 구조의 직렬화(serialization)과 역직렬화(deserialization)을 위한 바이너리 프토토콜 구현**
    - 오브젝트를 다른 형태의 데이터로 변화시키는 방법들중 하나
  - 종류
    - pickling(= serialization = marshalling = flattening)
      - 파이썬 객체 계층 구조 -> 바이트 스트림
    - unpickling
      - 바이트 스트림 -> 파이썬 객체 계층 구조
- 참고
  - `pickle`모듈은 안전하지 않으므로, 신뢰할 수 있는 데이터만 unpickle해야 함
    - unpickle시, 임의의 악의적인 코드를 실행하는 피클 데이터를 구성할 수 있음
  - 변조되지 않았음을 보장하기 위해서 `hmac`으로 데이터에 서명하는 것을 고려해야 함
  - 신뢰할 수 없는 데이터 처리에는 `json`과 같은 안전한 직렬화 형식이 더 적합할 수 있음

### 다른 모듈과의 비교

- vs `marshal`
  - `marshal`
    - `.pyc` 파일을 지원하기 위해 존재
  - 차이점
    - 사용자 정의 클래스 직렬화 여부
      - `marshal`: 불가능
      - `pickle`: 클래스의 인스턴스를 투명하게 저장하고 복원할 수 있으나, **클래스 정의는 객체를 저장할 때와 같은 모듈에 존재하고 임포트 가능해야 함**
    - 파이썬 버전 간 이식성 보장 여부
      - `marshal`: `.pyc`파일을 지원하는 것이 주 목적이므로, 과거 호환되지 않는 방식으로 변경할 권리를 갖음
      - `pickle`: 호환성 있는 피클 프로토콜이선택되고, major 버전 변경이 아니면, 과거 호환성 보장
- vs `json`(JSON serialization과 unserialization을 가능하게 하는 모듈)
  - 차이점
    - ① 직렬화 형식
      - `json`: UTF-8 (유니코드 텍스트)
      - `pickle`: binary
    - ② 사람이 읽을 수 있는가
    - ③ 보편성
      - `json`: 다양한 생태계에서 널리 활용
      - `pickle`: 파이썬 한정
    - ④ 표현성
      - `json`: 파이썬 내장형 일부만 표시 가능 & 사용자 정의 클래스 표시 불가능
      - `pickle`: 많은 수의 파이썬 타입을 나타낼 수 있음
        - 직접 API를 구현해서 타입 표시 가능
    - ⑤ 보안성
      - `json`: 역 직렬화가 그 자체로 임의 코드 실행 취약점을 만들지 않음
      - `pickle`: pickle에 악의적인 취약한 코드를 삽입 가능

### 데이터 스트림 형식

- `pickle`이 사용하는 데이터 형식은 파이썬에 고유
  - JSON / XDR 과 같은 외부 표준에 의해 부과된 제약 존재하지 않음
  - 비 파이썬 프로그램은 피클 된 파이썬 객체를 재구성할 수 없음
- 간결한 바이너리 표현을 사용
  - 압축 가능
- `pickletools`모듈에서는 `pickle`에 의해 생성된 데이터 스트림 분석 도구가 존재
- 피클링 프로토콜(6가지)
  - 0, 1, 2, 3, 4, 5(python 3.8에서 추가)

## 어떤 것이 피클 되고 역 피클 될 수 있는가?

### 피클 가능한 것들

- `None`, `True`, `False`
- 정수, 실수, 복소수
- 문자열, 바이트열, 바이트 배열
- 피클 가능한 객체만 포함하는 튜플, 리스트, 집합과 딕셔너리
- **모듈의 최상위 수준에서 정의된 함수(이름 참조 피클)**
  - decoratee와 같이 래핑되지 않아야 함
  - **즉, 함수가 정의된 모듈의 이름과 함께 함수의 이름만 피클 됨**
    - 코드와 속성은 피클되지 않음
    - 따라서, 정의하는 모듈은 역 피클 환경에서 임포트 가능해야 하며, 모듈에는 그 이름의 객체가 존재해야 함
- 모듈의 최상위 수준에서 정의된 내장 함수
- **모듈의 최상위 수준에서 정의된 클래스(이름 참조 피클)**
  - **그런 클래스의 인스턴스 중에서, `__dict__` 나 `__getstate__()`를 호출한 결과가 피클 가능한 것들**
    - *위의 조건 때문에 pickle불가능한 것들의 대표적인 예시?*
    - *스레드 객체는 위의 조건때문에 되지 않는것?*
  - 클래스 코드나 데이터가 피클되지 않음
    - 클래스 변수도 피클되지 않음

### 참고사항

- 피클 가능하지 않은 객체를 피클 하려고 하면 `PicklingError` 예외가 발생
  - 예외가 발생했을 때, 이미 파일에 특정 길이의 바이트열이 기록됐을 수 있음
- 매우 재귀적인 데이터 구조를 피클 하려고 하면, 최대 재귀 깊이를 초과할 수 있으며 이때에 `RecursionError`가 발생
  - `sys.setrecursionlimit()`을 사용하여 제한을 올릴 수 있음
  - *매우 재귀적인 데이터의 예시?*
