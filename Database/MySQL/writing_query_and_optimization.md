# 쿼리 작성과 최적화

- 의문
- 스키마 조작(DDL - Data Definition Language)
  - 개요

## 의문

## 스키마 조작(DDL - Data Definition Language)

### 개요

- 개요
  - 모든 오브젝트를 생성하거나 변경하는 쿼리
    - 스토어드 프로시저, 함수, DB, 테이블을 생성하거나 변경하는 대부분의 명령어
- 온라인 DDL
  - 개요
    - MySQL 5.5이하의 버전에서는 테이블 구조 변경 중에는 다른 커넥션에서 DML을 실행할 수 없었음
    - 따라서 `pt-online-schema-change`도구를 많이 사용 했었었음
      - 8.0부터는 내장 온라인 DDL기능으로 처리가 가능해져서 거의 사용하지 않음
  - 설정
    - `old_alter_table`시스템 변수를 이용해 ALTER TABLE 명령이 온라인 DDL로 작동할지, 아니면 예전방식(테이블 lock)으로 처리할지를 결정할 수 있음
      - MySQL 8.0이상의 버전에서는 기본값이 off이므로 자동으로 온라인 DDL이 활성화 됨
  - 알고리즘 종류
    - INSTANT
      - 데이터 변경 없이, 메타데이터만 변경하고 작업을 완료
      - 스키마 변경 시간이 매우 짧아서 다른 커넥션의 쿼리 처리에 큰 영향을 미치지 않음
    - INPLACE + (락: None, S-Lock, X-Lock)
      - 임시 테이블로 데이터를 복사하지 않고 스키마 변경 실행
        - 내부적으로는 테이블의 리빌드를 실행할 수도 있음
      - 스키마 변경중에 읽고 쓰기 가능
        - 맨 처음과 맨 마지막만 잠깐 읽고 쓰기 불가능하지만, 시간이 매우 짧음
      - 구분
        - 리빌드가 필요한 경우
          - 테이블 레코드 건수에 따라 상당히 많은 시간이 소요될 수 있음
          - e.g) 프라이머리 키 추가
        - 리빌드가 필요하지 않은 경우
          - 매우 빨리 작업이 완료될 수 있음
          - e.g) 칼럼 이름 변경
      - 벤치마크
        - 8Core Intel CPU(자원은 공유되는중)
          - 1100만 row inplace add column당 330초
          - **1만 row당 0.3초(0.5초라고 계산하는게 나을듯)**
    - COPY (락: X-Lock)
      - 변경된 스키마를 적용한 임시 테이블을 생성하고, 테이블의 레코드를 모두 임시 테이블로 복사한 후 최종적으로 임시 테이블을 RENAME해서 스키마 변경을 완료함
      - 읽기만 가능하고 DML(CUD) 실행 불가
