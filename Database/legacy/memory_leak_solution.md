# MySQL 메모리 누수 사례와 해결

## 당시 상황

- 메모리 누수가 일어난 데이터 베이스 상태
  - 10초에 한 번씩 행을 갱신하는 작업
  - 10초에 한 번씩 여러 칼럼의 이동평균을 구함
    - 10초 단위의 데이터의 10개 이상의 칼럼에 대해서 1분 평균을 1000개까지 구함
- 데이터 베이스 스펙
  - AWS RDS 가장 작은 스펙
  - 메모리: 500MB
  - 평균 잔여 메모리: 200 ~ 100MB
- 이동평균을 구하는 쿼리를 실행하기만 하면 메모리가 갑자기 낮아지고 회복되지 않음

## 해결

- 이동평균을 실시간으로 구하지말고, 테이블을 1분평균, 3분평균, ... 등으로 나눠서 데이터를 저장하면서 갱신해 나가도록 함
- 10초에 한 번씩 여러 칼럼의 이동평균을 구하는 쿼리가 단순히 `SELECT`문으로 단순화 됨
- 메모리 떄문에 멈추는 일 없어짐 + 평균 잔여 메모리가 400 이상을 유지
